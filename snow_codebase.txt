def execute_action(self, state: AgentState):
        """
        The Hands: Executes the action (Reset/Enroll) and creates a ticket.
        """
        last_message = state['messages'][-1].content
        # Extract action safely
        if ":" in last_message:
            action_type = last_message.split(":")[1].strip()
        else:
            action_type = "GENERAL_REQUEST"

        user_id = state['user_id']
        
        # 1. Fetch Profile
        user_profile = self.snow_client.get_user_profile(user_id)
        
        # --- LOGIC FIX START ---
        
        # Case A: Identity Verification Failed
        if not user_profile:
            return {
                "messages": [AIMessage(content="I couldn't verify your identity in ServiceNow. Please ensure your account is active or contact the Help Desk manually.")],
                "action_taken": None,  # IMPORTANT: Send None so frontend doesn't show "Ticket Created"
                "ticket_number": None
            }

        # Case B: Identity Verified - Proceed with Action
        response_text = ""
        ticket_number = None
        action_taken = None 

        if action_type == "PASSWORD_RESET":
            logger.info(f"Resetting password for {user_profile['email']}")
            response_text = f"I have initiated the password reset for {user_profile['user_name']}."
            short_desc = "Automated Password Reset"
        elif action_type == "DUO_ENROLLMENT":
            logger.info(f"Enrolling Duo for {user_profile['user_name']}")
            response_text = f"I have started the Duo enrollment for {user_profile['user_name']}."
            short_desc = "Automated Duo Enrollment"
        else:
            response_text = "I am creating a support ticket for your request."
            short_desc = "General Request"

        # 2. Create Incident
        ticket_number = self.snow_client.create_incident(
            caller_id=user_id,
            short_description=short_desc,
            description=f"Action: {action_type}\nChat Context: {state['messages']}",
            chat_history=state['messages']
        )
        
        # Case C: Ticket Creation Succeeded
        if ticket_number:
            response_text += f" (Reference: {ticket_number})"
            action_taken = "incident_created"
        else:
            # Case D: Ticket Creation Failed (API Error)
            response_text += " (Note: I failed to create a tracking ticket automatically. Please report this error.)"
            action_taken = None

        return {
            "messages": [AIMessage(content=response_text)],
            "action_taken": action_taken,
            "ticket_number": ticket_number
        }
        # --- LOGIC FIX END ---


$http.post('https://YOUR-APP-URL.azurewebsites.net/chat', payload).then(function(res) {
      c.isTyping = false;
      c.sessionId = res.data.session_id;
      
      // 1. Show the bot's text response
      c.messages.push({ text: res.data.response, isUser: false, time: getTime() });

      // 2. ONLY show the "Ticket Created" system message if ticket_number exists and is not null
      if(res.data.action_taken === 'incident_created' && res.data.ticket_number) {
        c.messages.push({ 
            text: "âœ… Ticket " + res.data.ticket_number + " has been created.", 
            isUser: false, 
            time: getTime() 
        });
      }
      
      scrollToBottom();
    }, function(err) {
      // ... error handling ...
    });
