requirements.txt

flask
flask-cors
langchain-openai
langchain-core
docx2txt
requests
python-dotenv

.env

# Azure OpenAI
AZURE_OPENAI_API_KEY=your_key_here
AZURE_OPENAI_ENDPOINT=https://your-resource.openai.azure.com/
AZURE_OPENAI_API_VERSION=2024-02-15-preview
AZURE_DEPLOYMENT_NAME=gpt-4o-mini

# ServiceNow
SNOW_INSTANCE_URL=https://your-instance.service-now.com
SNOW_API_USER=bot_integration_user
SNOW_API_PASSWORD=your_password

app.py

import os
import uuid
import logging
from flask import Flask, request, jsonify
from flask_cors import CORS
from dotenv import load_dotenv
from agents import MasterAgent

# Load Environment Variables
load_dotenv()

# Setup Logging
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

app = Flask(__name__)

# Allow CORS for your ServiceNow Instance
CORS(app, resources={r"/chat": {"origins": "*"}}) 

# In-memory session storage
chat_sessions = {}

@app.route('/health', methods=['GET'])
def health():
    return jsonify({"status": "online", "model": "gpt-4o-mini"}), 200

@app.route('/chat', methods=['POST'])
def chat():
    try:
        data = request.json
        user_message = data.get('message')
        session_id = data.get('session_id')
        user_id = data.get('user_id')  # sys_id from ServiceNow

        # Create new session if needed
        if not session_id or session_id not in chat_sessions:
            session_id = str(uuid.uuid4())
            logger.info(f"New session: {session_id} for user: {user_id}")
            chat_sessions[session_id] = MasterAgent(session_id, user_id)

        agent = chat_sessions[session_id]
        
        # Process Message
        result = agent.process_request(user_message)

        # Cleanup if ticket created (start fresh next time)
        if result.get('action_taken') == 'incident_created':
            del chat_sessions[session_id]

        return jsonify({
            "response": result['text'],
            "session_id": session_id,
            "action_taken": result.get('action_taken'),
            "ticket_number": result.get('ticket_number')
        })

    except Exception as e:
        logger.error(f"Error: {str(e)}")
        return jsonify({"error": "Internal Server Error"}), 500

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=8000)

