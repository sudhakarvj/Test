import os
import requests
import json
import logging

logger = logging.getLogger(__name__)

class ServiceNowClient:
    def __init__(self):
        self.instance_url = os.getenv("SNOW_INSTANCE_URL")
        self.user = os.getenv("SNOW_API_USER")
        self.password = os.getenv("SNOW_API_PASSWORD")
        self.headers = {"Content-Type": "application/json", "Accept": "application/json"}

    def get_user_profile(self, user_sys_id):
        url = f"{self.instance_url}/api/now/table/sys_user/{user_sys_id}"
        params = {"sysparm_fields": "user_name,email,first_name,last_name"}
        try:
            response = requests.get(url, auth=(self.user, self.password), headers=self.headers, params=params)
            if response.status_code == 200:
                result = response.json().get('result')
                if result: return result
            return None
        except Exception as e:
            logger.error(f"SNOW Error: {e}")
            return None

    def create_incident(self, caller_id, short_description, description, chat_history):
        url = f"{self.instance_url}/api/now/table/incident"
        notes = "\n".join([f"{m.type}: {m.content}" for m in chat_history])
        
        payload = {
            "caller_id": caller_id,
            "short_description": short_description,
            "description": description,
            "work_notes": notes,
            "category": "software",
            "contact_type": "virtual_agent"
        }
        
        try:
            response = requests.post(url, auth=(self.user, self.password), headers=self.headers, data=json.dumps(payload))
            if response.status_code == 201:
                return response.json()['result']['number']
            return None
        except Exception:
            return None
