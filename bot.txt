import requests
import json
import random
import string
import time
from flask import Flask, request, jsonify
from flask_cors import CORS

app = Flask(__name__)
CORS(app)

# ==========================================
# 1. CONFIGURATION (Fill these in)
# ==========================================
# ServiceNow
SN_INSTANCE = 'https://YOUR_INSTANCE.service-now.com'
SN_USER = 'admin'
SN_PASS = 'password'

# Microsoft Azure (Entra ID)
AZURE_TENANT = 'your-tenant-id'
AZURE_CLIENT_ID = 'your-client-id'
AZURE_SECRET = 'your-client-secret'

# Duo Security
DUO_API_HOST = 'api-xxxx.duosecurity.com'
DUO_IKEY = 'your-integration-key'
DUO_SKEY = 'your-secret-key'

# ==========================================
# 2. HELPER FUNCTIONS (The Logic)
# ==========================================

# --- Helper: Generate a random temporary password ---
def generate_temp_password():
    # Azure requires complex passwords (Upper + Lower + Digit + Symbol)
    chars = string.ascii_letters + string.digits + "!@#$%"
    return ''.join(random.choice(chars) for i in range(12))

# --- Helper: Create ServiceNow Ticket (Audit Log) ---
def create_audit_ticket(short_desc, work_notes):
    url = f"{SN_INSTANCE}/api/now/table/incident"
    payload = {
        "short_description": short_desc,
        "description": "Automated Action by Chatbot.",
        "work_notes": work_notes,
        "category": "network",
        "contact_type": "virtual_agent",
        "state": "6", # "6" usually means Resolved (verify your instance codes)
        "close_code": "Solved (Permanently)",
        "close_notes": "Bot performed action successfully."
    }
    try:
        response = requests.post(url, auth=(SN_USER, SN_PASS), json=payload)
        if response.status_code == 201:
            return response.json()['result']['number']
    except Exception as e:
        print(f"SN Error: {e}")
    return "TICKET_FAILED"

# --- ACTION 1: Azure Password Reset ---
def perform_azure_reset(user_email):
    new_password = generate_temp_password()
    
    # 1. Get Azure Access Token (Real logic)
    token_url = f"https://login.microsoftonline.com/{AZURE_TENANT}/oauth2/v2.0/token"
    token_data = {
        'grant_type': 'client_credentials',
        'client_id': AZURE_CLIENT_ID,
        'client_secret': AZURE_SECRET,
        'scope': 'https://graph.microsoft.com/.default'
    }
    
    # Mocking the actual API call for safety in this example
    # In production, uncomment the requests.post below
    # token_r = requests.post(token_url, data=token_data)
    # token = token_r.json().get('access_token')
    
    # 2. Call Graph API to reset password
    # graph_url = f"https://graph.microsoft.com/v1.0/users/{user_email}"
    # password_payload = {
    #     "passwordProfile": {
    #         "forceChangePasswordNextSignIn": True,
    #         "password": new_password
    #     }
    # }
    # requests.patch(graph_url, json=password_payload, headers={'Authorization': f'Bearer {token}'})
    
    print(f"[MOCK] Reseting Azure Password for {user_email} to {new_password}")
    return new_password

# --- ACTION 2: Duo Enrollment ---
def perform_duo_enrollment(user_email):
    # Real logic would use the 'duo_client' python library or REST API
    # POST /admin/v1/users to create user
    # POST /admin/v1/users/{user_id}/phones to add phone
    # POST /admin/v1/users/{user_id}/activation_url to send SMS
    
    print(f"[MOCK] Sending Duo Enrollment SMS to {user_email}")
    return "SMS Sent"

# --- ACTION 3: Cisco VPN Reset ---
def perform_vpn_reset(user_email):
    # This usually requires SSH into the Cisco ASA or an API Gateway
    # Example: Disconnect-VPNUser -UserName user_email
    
    print(f"[MOCK] Kicking VPN session for {user_email}")
    return "Session Cleared"


# ==========================================
# 3. THE BRAIN (Intent & Orchestration)
# ==========================================

@app.route('/chat', methods=['POST'])
def chat():
    data = request.json
    message = data.get('message', '').lower()
    user_email = data.get('email', 'test.user@company.com') # In real widget, pass this from Portal
    
    response_text = ""
    action_log = ""
    action_type = ""

    # --- SCENARIO 1: PASSWORD RESET ---
    if "password" in message:
        action_type = "Password Reset"
        
        # 1. Do the Action
        new_pass = perform_azure_reset(user_email)
        
        # 2. Prepare User Response (Display Password)
        response_text = f"✅ SUCCESS: I have reset your Azure AD password.\n\nYour new temporary password is: {new_pass}\n\nPlease perform a password change immediately upon login."
        action_log = f"Bot reset password for {user_email}. Temp password provided in chat."

    # --- SCENARIO 2: DUO ENROLLMENT ---
    elif "duo" in message:
        action_type = "Duo Enrollment"
        
        # 1. Do the Action
        status = perform_duo_enrollment(user_email)
        
        # 2. Prepare User Response
        response_text = "✅ SUCCESS: I have triggered the Duo enrollment process. Please check your phone for an SMS/Email with the setup link."
        action_log = f"Bot triggered Duo enrollment SMS for {user_email}."

    # --- SCENARIO 3: CISCO VPN ---
    elif "vpn" in message or "cisco" in message:
        action_type = "VPN Reset"
        
        # 1. Do the Action
        status = perform_vpn_reset(user_email)
        
        # 2. Prepare User Response
        response_text = "✅ SUCCESS: I have cleared your hung VPN session on the Cisco gateway. Please wait 30 seconds and try connecting again."
        action_log = f"Bot cleared VPN session for {user_email}."
        
    else:
        return jsonify({"text": "I can help with: 1. Password Reset, 2. Duo Enrollment, 3. Cisco VPN issues."})

    # --- FINAL STEP: CREATE TICKET (After Action) ---
    # We create the ticket silently in the background
    ticket_num = create_audit_ticket(
        short_desc=f"Bot Action: {action_type} for {user_email}", 
        work_notes=action_log
    )
    
    # Append ticket info to the user response
    response_text += f"\n\n(Audit Ticket {ticket_num} has been logged and closed)."

    return jsonify({"text": response_text})

if __name__ == '__main__':
    app.run(debug=True, port=5000)


A. HTML Template

<div class="bot-container">
  <div class="chat-header">IT Support Bot</div>
  
  <div class="chat-window" id="chatWindow">
    <div ng-repeat="msg in c.messages" 
         ng-class="{'user-msg': msg.author=='me', 'bot-msg': msg.author=='bot'}">
      <div class="bubble">{{msg.text}}</div>
    </div>
  </div>

  <div class="chat-input-area">
    <input type="text" 
           ng-model="c.userMessage" 
           ng-keydown="c.checkEnter($event)"
           placeholder="Type 'Reset password' or 'VPN issue'...">
    <button ng-click="c.sendMessage()">Send</button>
  </div>
</div>

B. CSS (SCSS)

.bot-container {
  width: 350px;
  border: 1px solid #ccc;
  border-radius: 8px;
  background: #fff;
  float: right; /* Keeps it to the right */
  box-shadow: 0 4px 10px rgba(0,0,0,0.1);
}

.chat-header {
  background-color: #2e3b4e; /* ServiceNow Dark Blue */
  color: white;
  padding: 10px;
  font-weight: bold;
  border-top-left-radius: 8px;
  border-top-right-radius: 8px;
}

.chat-window {
  height: 300px;
  overflow-y: auto;
  padding: 10px;
  background-color: #f5f5f5;
}

.user-msg { text-align: right; margin: 5px 0; }
.bot-msg { text-align: left; margin: 5px 0; }

.bubble {
  display: inline-block;
  padding: 8px 12px;
  border-radius: 15px;
  max-width: 80%;
}

.user-msg .bubble { background-color: #007bff; color: white; }
.bot-msg .bubble { background-color: #e0e0e0; color: black; }

.chat-input-area {
  padding: 10px;
  border-top: 1px solid #eee;
  display: flex;
}

input { flex-grow: 1; padding: 5px; border-radius: 4px; border: 1px solid #ddd; }
button { margin-left: 5px; padding: 5px 10px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; }

C. Client Script

api.controller = function($http, $scope) {
  var c = this;
  
  // 1. Initialize Chat
  c.messages = [];
  c.messages.push({author: 'bot', text: 'Hello! I can help with Password Reset, Duo, or VPN.'});
  c.userMessage = '';

  // 2. Function to Send Message
  c.sendMessage = function() {
    if (!c.userMessage) return;

    // Add User message to UI
    c.messages.push({author: 'me', text: c.userMessage});
    
    // Prepare Payload
    // We get the Logged-in User's email from ServiceNow automatically ($scope.user.email)
    var payload = {
      "message": c.userMessage,
      "email": $scope.user.email || "guest@example.com" 
    };

    var currentMsg = c.userMessage; // Store temp
    c.userMessage = ''; // Clear input

    // 3. CALL EXTERNAL PYTHON BOT
    // REPLACE THIS URL with your ngrok or server URL
    var botURL = "https://a1b2-c3d4.ngrok.io/chat"; 

    $http.post(botURL, payload).then(function(response) {
      // Success: Add Bot Response to UI
      c.messages.push({author: 'bot', text: response.data.text});
      
      // Auto-scroll to bottom
      setTimeout(function(){
          var chatWindow = document.getElementById('chatWindow');
          chatWindow.scrollTop = chatWindow.scrollHeight;
      }, 100);

    }, function(error) {
      // Error handling
      console.log("Bot Error:", error);
      c.messages.push({author: 'bot', text: "Error connecting to bot server."});
    });
  };

  // Allow pressing "Enter" key
  c.checkEnter = function(keyEvent) {
    if (keyEvent.which === 13) c.sendMessage();
  };
};

